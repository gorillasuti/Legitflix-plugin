var re;(function(n){n.RAW="RAW",n.PROXY="PROXY",n.THROW="THROW",n.HANDLER="HANDLER"})(re||(re={}));var k;(function(n){n.GET="GET",n.SET="SET",n.APPLY="APPLY",n.CONSTRUCT="CONSTRUCT",n.RELEASE="RELEASE"})(k||(k={}));const tt=Symbol("Abslink.proxy"),ir=Symbol("Abslink.releaseProxy"),ve=Symbol("Abslink.finalizer"),Be=Symbol("Abslink.thrown"),vr=n=>typeof n=="object"&&n!==null||typeof n=="function",os={canHandle:n=>vr(n)&&tt in n,serialize(n,s){const a=n[tt];return yr(n,s,a),a},deserialize(n,s){return hs(s,void 0,n)}};function ls(n){"close"in n&&typeof n.close=="function"&&n.close()}const cs={canHandle:n=>vr(n)&&Be in n,serialize({value:n}){let s;return n instanceof Error?s={isError:!0,value:{message:n.message,name:n.name,stack:n.stack}}:s={isError:!1,value:n},s},deserialize(n){throw n.isError?Object.assign(new Error(n.value.message),n.value):n.value}},pr=new Map([["proxy",os],["throw",cs]]);function us(n,s){let a=s;const c=n.slice(0,-1);for(const p of c)Object.prototype.hasOwnProperty.call(a,p)&&(a=a[p]);const h=n[n.length-1],v=h?a[h]:a;return{parent:a,RawValue:v,lastSegment:h}}function yr(n,s,a){return s.on("message",function c(h){if(!h)return;const{id:v,type:p,path:_,markerID:A}={path:[],...h};if(A!==a)return;const m=(h.argumentList??[]).map(y=>te(y,s));let g;try{const{parent:y,RawValue:x,lastSegment:E}=us(_,n);switch(p){case k.GET:g=x;break;case k.SET:y[E]=te(h.value,s),g=!0;break;case k.APPLY:g=x.apply(y,m);break;case k.CONSTRUCT:{const M=new x(...m);g=gs(M)}break;case k.RELEASE:g=void 0;break;default:return}}catch(y){g={value:y,[Be]:0}}Promise.resolve(g).catch(y=>({value:y,[Be]:0})).then(y=>{const x=ke(y,s);s.postMessage({...x,id:v,markerID:a}),p===k.RELEASE&&(s.off("message",c),ve in n&&typeof n[ve]=="function"&&n[ve]())}).catch(y=>{const x=ke({value:new TypeError("Unserializable return value"),[Be]:0},s);s.postMessage({...x,id:v,markerID:a})})}),n}function hs(n,s,a){const c=new Map;return n.on("message",h=>{if(!h?.id)return;const v=c.get(h.id);if(v)try{v(h)}finally{c.delete(h.id)}}),rt({endpoint:n,pendingListeners:c,nextRequestId:1},[],s,a)}function $e(n){if(n)throw new Error("Proxy has been released and is not useable")}async function mr(n){await _e(n,{type:k.RELEASE}),ls(n.endpoint)}const Le=new WeakMap,Ue="FinalizationRegistry"in globalThis&&new FinalizationRegistry(n=>{const s=(Le.get(n)??0)-1;Le.set(n,s),s===0&&mr(n).finally(()=>{n.pendingListeners.clear()})});function fs(n,s){const a=(Le.get(s)??0)+1;Le.set(s,a),Ue&&Ue.register(n,s,n)}function ds(n){Ue&&Ue.unregister(n)}function rt(n,s=[],a=function(){},c){let h=!1;const v=new Map,p=new Proxy(a,{get(_,A){if($e(h),A===ir)return async()=>{for(const y of v.values())y[ir]();v.clear(),ds(p),mr(n).finally(()=>{n.pendingListeners.clear()}),h=!0};if(A==="then"){if(s.length===0)return{then:()=>p};const y=_e(n,{type:k.GET,markerID:c,path:s.map(x=>x.toString())}).then(x=>te(x,n.endpoint));return y.then.bind(y)}const m=v.get(A);if(m)return m;const g=rt(n,[...s,A],void 0,c);return v.set(A,g),g},set(_,A,m){$e(h);const g=ke(m,n.endpoint);return _e(n,{type:k.SET,markerID:c,path:[...s,A].map(y=>y.toString()),value:g}).then(y=>te(y,n.endpoint))},apply(_,A,m){if($e(h),s[s.length-1]==="bind")return rt(n,s.slice(0,-1),void 0,c);const y=sr(m,n);return _e(n,{type:k.APPLY,markerID:c,path:s.map(x=>x.toString()),argumentList:y}).then(x=>te(x,n.endpoint))},construct(_,A){$e(h);const m=sr(A,n);return _e(n,{type:k.CONSTRUCT,markerID:c,path:s.map(g=>g.toString()),argumentList:m}).then(g=>te(g,n.endpoint))}});return fs(p,n),p}function sr(n,s){return n.map(a=>ke(a,s.endpoint))}function gs(n){return Object.assign(n,{[tt]:br()})}function ke(n,s){for(const[a,c]of pr)if(c.canHandle(n)){const h=c.serialize(n,s);return{type:re.HANDLER,name:a,value:h}}return{type:re.RAW,value:n}}function te(n,s){switch(n.type){case re.HANDLER:return pr.get(n.name).deserialize(n.value,s);case re.RAW:return n.value}}function _e(n,s){return new Promise(a=>{const c=br();n.pendingListeners.set(c,a),n.endpoint.postMessage({id:c,...s})})}function br(){return Math.trunc(Math.random()*Number.MAX_SAFE_INTEGER).toString()}function _s(n,s){const a=new WeakMap;return{on(c,h){const v=p=>h(p.data);"addEventListener"in n?n.addEventListener(c,v):"addListener"in n?n.addListener(c,v):n.on(c,v),a.set(h,v)},off(c,h){const v=a.get(h);"removeEventListener"in n?n.removeEventListener(c,v):"removeListener"in n?n.removeListener(c,v):n.off(c,v),a.delete(h)},postMessage(c){s.postMessage(c)},[ve]:()=>{n.terminate?.(),s.terminate?.()}}}function vs(n,s=self,a=s){return yr(n,_s(s,a))}const ar={100:"Thin",200:"ExtraLight",300:"Light",400:"Regular",500:"Medium",600:"SemiBold",700:"Bold",800:"ExtraBold",900:"Black",1e3:"UltraBlack"};class nr{family;fullName;postscriptName;style;#t;#e;constructor({family:s,weight:a,isItalic:c,weightName:h}){this.family=s,this.#t=a,this.#e=c,h==="Regular"?c?this.style="Italic":this.style="Regular":this.style=h+(c?" Italic":""),this.style==="Regular"?this.fullName=s:this.fullName=`${s} ${this.style}`,this.postscriptName=this.fullName.replace(/ /g,"-")}async blob(){const a=await(await fetch(`https://fonts.googleapis.com/css2?family=${this.family}:${this.#e?"ital,":""}wght@${this.#e?"1,":""}${this.#t}`)).text(),c=[/\/\* latin-ext \*\/[\s\S]+url\(([^)]+)\)/,/\/\* latin \*\/[\s\S]+url\(([^)]+)\)/,/url\(([^)]+)\)/];for(const h of c){const v=a.match(h)?.[1];if(v){const p=await fetch(v);if(p.ok)return p.blob()}}throw new Error("Failed to load font blob")}}function ps([n,s]){const a=[];for(const c of s){const h=""+c,v=h.endsWith("i"),p=h.replace("i","");if(p.includes("a")){const[_,A]=p.split("a").map(m=>parseInt(m)*100);for(let m=_;m<=A;m+=100)a.push(new nr({family:n,weight:`${_}..${A}`,isItalic:v,weightName:ar[m]}))}else a.push(new nr({family:n,weight:`${p}00`,isItalic:v,weightName:ar[parseInt(p)*100]}))}return a}let Qe=new Map;async function ys(){if(Qe.size===0){const n=await import("./fonts-PJb5Exrg.js");for(const s of n.default.flatMap(a=>ps(a)))Qe.set(s.postscriptName.toLowerCase().replace(/-/g,""),s)}return Qe}async function ms({postscriptNames:n}={}){const s=await ys();return n?n.length===0?[]:n.reduce((a,c)=>{const h=s.get(c.toLowerCase().replace(/regular$/,"").replace(/-reg$/,"").replace(/[- ]/g,""));return h&&a.push(h),a},[]):[...s.values()]}async function Ar(n={}){var s,a=n,c=(...e)=>console.log(...e),h=(...e)=>console.error(...e);function v(){y?.(a),_&&x()}var p=!!globalThis.WorkerGlobalScope,_=p&&self.name?.startsWith("em-pthread");const A=!!WebAssembly.Memory.prototype.toResizableBuffer;if(Z=()=>{if(!(A&&self.HEAPU8RAW)){var e=A?O.toResizableBuffer():O.buffer;M=new Int8Array(e),X=new Int16Array(e),S=new Uint8Array(e),j=new Uint16Array(e),z=new Int32Array(e),F=new Uint32Array(e),se=new Float32Array(e),q=new Float64Array(e),N=new BigInt64Array(e),ae=new BigUint64Array(e),self.HEAPU8RAW=new Uint8Array(e),self.WASMMEMORY=O}},self.name.startsWith("em-pthread")){const e=self.name.split("-").slice(2).join("-"),t=globalThis.fetch;globalThis.fetch=r=>t(e)}else{n.__out&&(c=n.__out),n.__err&&(h=n.__err);const e=globalThis.Worker;globalThis.Worker=class extends e{constructor(t,r={}){super(t,{...r,name:"em-pthread-"+n.__url})}}}function m(e){throw e}function g(){O.buffer!=M.buffer&&Z()}var y,x;if(_){let e=function(t){try{var r=t.data,i=r.cmd;if(i==="load"){let o=[];self.onmessage=l=>o.push(l),x=()=>{postMessage({cmd:"loaded"});for(let l of o)e(l);self.onmessage=e};for(const l of r.handlers)(!a[l]||a[l].proxy)&&(a[l]=(...u)=>{postMessage({cmd:"callHandler",handler:l,args:u})},l=="print"&&(c=a[l]),l=="printErr"&&(h=a[l]));O=r.wasmMemory,Z(),a.wasm=r.wasmModule,Jt()}else if(i==="run"){Fr(r.pthread_ptr),Ze(r.pthread_ptr,0,0,1,0,0),T.threadInitTLS(),Ge(r.pthread_ptr),E||(Wt(),E=!0);try{Sr(r.start_routine,r.arg)}catch(o){if(o!="unwind")throw o}}else r.target==="setimmediate"||(i==="checkMailbox"?E&&Pe():i&&(h(`worker: received unknown command ${i}`),h(r)))}catch(o){throw Ot(),o}};var E=!1;self.onunhandledrejection=t=>{throw t.reason||t},self.onmessage=e}var M,S,X,j,z,F,se,q,N,ae,pe=!1;function Z(){var e=O.buffer;M=new Int8Array(e),X=new Int16Array(e),S=new Uint8Array(e),j=new Uint16Array(e),z=new Int32Array(e),F=new Uint32Array(e),se=new Float32Array(e),q=new Float64Array(e),N=new BigInt64Array(e),ae=new BigUint64Array(e)}function Ie(){if(!_){{var e=62914560;O=new WebAssembly.Memory({initial:e/65536,maximum:32768,shared:!0})}Z()}}Ie();var ye=e=>{e.terminate(),e.onmessage=t=>{}},me=e=>{var t=T.pthreads[e];T.returnWorkerToPool(t)},xr=e=>{for(;e.length>0;)e.shift()(a)},Cr=[],st=e=>{var t=T.getNewWorker();if(!t)return 6;T.runningWorkers.push(t),T.pthreads[e.pthread_ptr]=t,t.pthread_ptr=e.pthread_ptr;var r={cmd:"run",start_routine:e.startRoutine,arg:e.arg,pthread_ptr:e.pthread_ptr};return t.postMessage(r,e.transferList),0},be=()=>qt(),ne=e=>Xt(e),Er=e=>jt(e),B=(e,t,r,...i)=>{for(var o=i.length*2,l=be(),u=Er(o*8),f=u>>3,d=0;d<i.length;d++){var b=i[d];typeof b=="bigint"?((g(),N)[f+2*d]=1n,(g(),N)[f+2*d+1]=b):((g(),N)[f+2*d]=0n,(g(),q)[f+2*d+1]=b)}var R=Nt(e,t,o,u,r);return ne(l),R};function We(e){if(_)return B(0,0,1,e);throw`exit(${e})`}var Pr=We,T={unusedWorkers:[],runningWorkers:[],tlsInitFunctions:[],pthreads:{},init(){_||T.initMainThread()},initMainThread(){for(var e=!navigator.userAgent.toLowerCase().includes("firefox")&&self.crossOriginIsolated?Math.min(Math.max(0,navigator.hardwareConcurrency-2),8):0;e--;)T.allocateUnusedWorker()},terminateAllThreads:()=>{for(var e of T.runningWorkers)ye(e);for(var e of T.unusedWorkers)ye(e);T.unusedWorkers=[],T.runningWorkers=[],T.pthreads={}},returnWorkerToPool:e=>{var t=e.pthread_ptr;delete T.pthreads[t],T.unusedWorkers.push(e),T.runningWorkers.splice(T.runningWorkers.indexOf(e),1),e.pthread_ptr=0,Ht(t)},threadInitTLS(){T.tlsInitFunctions.forEach(e=>e())},loadWasmModuleToWorker:e=>new Promise(t=>{e.onmessage=l=>{var u=l.data,f=u.cmd;if(u.targetThread&&u.targetThread!=qe()){var d=T.pthreads[u.targetThread];d?d.postMessage(u,u.transferList):h(`Internal error! Worker sent a message "${f}" to target pthread ${u.targetThread}, but that thread no longer exists!`);return}f==="checkMailbox"?Pe():f==="spawnThread"?st(u):f==="cleanupThread"?Ve(()=>me(u.thread)):f==="loaded"?(e.loaded=!0,t(e)):u.target==="setimmediate"?e.postMessage(u):f==="callHandler"?a[u.handler](...u.args):f&&h(`worker sent an unknown command ${f}`)},e.onerror=l=>{var u="worker sent an error!";throw h(`${u} ${l.filename}:${l.lineno}: ${l.message}`),l};var r=[],i=[];for(var o of i)a.propertyIsEnumerable(o)&&r.push(o);e.postMessage({cmd:"load",handlers:r,wasmMemory:O,wasmModule:Qt})}),async loadWasmModuleToAllWorkers(){return _?void 0:Promise.all(T.unusedWorkers.map(T.loadWasmModuleToWorker))},allocateUnusedWorker(){var e;e=new Worker(new URL("/LegitFlix/Client/jassub-worker-DCdxIu_A.js",import.meta.url),{type:"module",name:"em-pthread"}),T.unusedWorkers.push(e)},getNewWorker(){return T.unusedWorkers.length==0&&(T.allocateUnusedWorker(),T.loadWasmModuleToWorker(T.unusedWorkers[0])),T.unusedWorkers.pop()}};function Fr(e){var t=(g(),F)[e+52>>2],r=(g(),F)[e+56>>2],i=t-r;Gt(t,i),ne(t)}var at=[],oe=e=>{var t=at[e];return t||(at[e]=t=Zt.get(e)),t},Sr=(e,t)=>{var r=oe(e)(t);function i(o){zt(o)}i(r)},O,nt=new TextDecoder,Oe=(e,t,r,i)=>{var o=t+r;if(i)return o;for(;e[t]&&!(t>=o);)++t;return t},le=(e,t,r)=>{if(!e)return"";var i=Oe((g(),S),e,t,r);return nt.decode((g(),S).slice(e,i))},$r=(e,t,r,i)=>m(`Assertion failed: ${le(e)}, at: `+[t?le(t):"unknown filename",r,i?le(i):"unknown function"]);function ot(e,t,r,i){return _?B(1,0,1,e,t,r,i):lt(e,t,r,i)}var Dr=()=>!!globalThis.SharedArrayBuffer,lt=(e,t,r,i)=>{if(!Dr())return 6;var o=[],l=0;if(_&&(o.length===0||l))return ot(e,t,r,i);var u={startRoutine:r,pthread_ptr:e,arg:i,transferList:o};return _?(u.cmd="spawnThread",postMessage(u,o),0):st(u)};function ct(e,t,r){return _?B(2,0,1,e,t,r):0}function ut(e,t,r){if(_)return B(3,0,1,e,t,r)}function ht(e,t,r){return _?B(4,0,1,e,t,r):0}function ft(e,t,r,i){if(_)return B(5,0,1,e,t,r,i)}var Mr=()=>m(""),L=e=>{for(var t="";;){var r=(g(),S)[e++];if(!r)return t;t+=String.fromCharCode(r)}},Q={},J={},Ae={},ce=class extends Error{constructor(t){super(t),this.name="BindingError"}},w=e=>{throw new ce(e)};function Br(e,t,r={}){var i=t.name;if(e||w(`type "${i}" must have a positive integer typeid pointer`),J.hasOwnProperty(e)){if(r.ignoreDuplicateRegistrations)return;w(`Cannot register type '${i}' twice`)}if(J[e]=t,delete Ae[e],Q.hasOwnProperty(e)){var o=Q[e];delete Q[e],o.forEach(l=>l())}}function H(e,t,r={}){return Br(e,t,r)}var dt=(e,t,r)=>{switch(t){case 1:return r?i=>(g(),M)[i]:i=>(g(),S)[i];case 2:return r?i=>(g(),X)[i>>1]:i=>(g(),j)[i>>1];case 4:return r?i=>(g(),z)[i>>2]:i=>(g(),F)[i>>2];case 8:return r?i=>(g(),N)[i>>3]:i=>(g(),ae)[i>>3];default:throw new TypeError(`invalid integer width (${t}): ${e}`)}},Lr=(e,t,r,i,o)=>{t=L(t);const l=i===0n;let u=f=>f;if(l){const f=r*8;u=d=>BigInt.asUintN(f,d),o=u(o)}H(e,{name:t,fromWireType:u,toWireType:(f,d)=>(typeof d=="number"&&(d=BigInt(d)),d),readValueFromPointer:dt(t,r,!l),destructorFunction:null})},Ur=(e,t,r,i)=>{t=L(t),H(e,{name:t,fromWireType:function(o){return!!o},toWireType:function(o,l){return l?r:i},readValueFromPointer:function(o){return this.fromWireType((g(),S)[o])},destructorFunction:null})},kr=e=>({count:e.count,deleteScheduled:e.deleteScheduled,preservePointerOnDelete:e.preservePointerOnDelete,ptr:e.ptr,ptrType:e.ptrType,smartPtr:e.smartPtr,smartPtrType:e.smartPtrType}),Ne=e=>{function t(r){return r.$$.ptrType.registeredClass.name}w(t(e)+" instance already deleted")},He=!1,gt=e=>{},Ir=e=>{e.smartPtr?e.smartPtrType.rawDestructor(e.smartPtr):e.ptrType.registeredClass.rawDestructor(e.ptr)},_t=e=>{e.count.value-=1;var t=e.count.value===0;t&&Ir(e)},ue=e=>globalThis.FinalizationRegistry?(He=new FinalizationRegistry(t=>{_t(t.$$)}),ue=t=>{var r=t.$$,i=!!r.smartPtr;if(i){var o={$$:r};He.register(t,o,t)}return t},gt=t=>He.unregister(t),ue(e)):(ue=t=>t,e),Wr=()=>{let e=Te.prototype;Object.assign(e,{isAliasOf(r){if(!(this instanceof Te)||!(r instanceof Te))return!1;var i=this.$$.ptrType.registeredClass,o=this.$$.ptr;r.$$=r.$$;for(var l=r.$$.ptrType.registeredClass,u=r.$$.ptr;i.baseClass;)o=i.upcast(o),i=i.baseClass;for(;l.baseClass;)u=l.upcast(u),l=l.baseClass;return i===l&&o===u},clone(){if(this.$$.ptr||Ne(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var r=ue(Object.create(Object.getPrototypeOf(this),{$$:{value:kr(this.$$)}}));return r.$$.count.value+=1,r.$$.deleteScheduled=!1,r},delete(){this.$$.ptr||Ne(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&w("Object already scheduled for deletion"),gt(this),_t(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)},isDeleted(){return!this.$$.ptr},deleteLater(){return this.$$.ptr||Ne(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&w("Object already scheduled for deletion"),this.$$.deleteScheduled=!0,this}});const t=Symbol.dispose;t&&(e[t]=e.delete)};function Te(){}var vt=(e,t)=>Object.defineProperty(t,"name",{value:e}),pt={},yt=(e,t,r)=>{if(e[t].overloadTable===void 0){var i=e[t];e[t]=function(...o){return e[t].overloadTable.hasOwnProperty(o.length)||w(`Function '${r}' called with an invalid number of arguments (${o.length}) - expects one of (${e[t].overloadTable})!`),e[t].overloadTable[o.length].apply(this,o)},e[t].overloadTable=[],e[t].overloadTable[i.argCount]=i}},Or=(e,t,r)=>{a.hasOwnProperty(e)?(w(`Cannot register public name '${e}' twice`),yt(a,e,e),a[e].overloadTable.hasOwnProperty(r)&&w(`Cannot register multiple overloads of a function with the same number of arguments (${r})!`),a[e].overloadTable[r]=t):(a[e]=t,a[e].argCount=r)},Nr=48,Hr=57,zr=e=>{e=e.replace(/[^a-zA-Z0-9_]/g,"$");var t=e.charCodeAt(0);return t>=Nr&&t<=Hr?`_${e}`:e};function Yr(e,t,r,i,o,l,u,f){this.name=e,this.constructor=t,this.instancePrototype=r,this.rawDestructor=i,this.baseClass=o,this.getActualType=l,this.upcast=u,this.downcast=f,this.pureVirtualFunctions=[]}var we=(e,t,r)=>{for(;t!==r;)t.upcast||w(`Expected null or instance of ${r.name}, got an instance of ${t.name}`),e=t.upcast(e),t=t.baseClass;return e},ze=e=>{if(e===null)return"null";var t=typeof e;return t==="object"||t==="array"||t==="function"?e.toString():""+e};function Vr(e,t){if(t===null)return this.isReference&&w(`null is not a valid ${this.name}`),0;t.$$||w(`Cannot pass "${ze(t)}" as a ${this.name}`),t.$$.ptr||w(`Cannot pass deleted object as a pointer of type ${this.name}`);var r=t.$$.ptrType.registeredClass,i=we(t.$$.ptr,r,this.registeredClass);return i}function Gr(e,t){var r;if(t===null)return this.isReference&&w(`null is not a valid ${this.name}`),this.isSmartPointer?(r=this.rawConstructor(),e!==null&&e.push(this.rawDestructor,r),r):0;(!t||!t.$$)&&w(`Cannot pass "${ze(t)}" as a ${this.name}`),t.$$.ptr||w(`Cannot pass deleted object as a pointer of type ${this.name}`),!this.isConst&&t.$$.ptrType.isConst&&w(`Cannot convert argument of type ${t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name} to parameter type ${this.name}`);var i=t.$$.ptrType.registeredClass;if(r=we(t.$$.ptr,i,this.registeredClass),this.isSmartPointer)switch(t.$$.smartPtr===void 0&&w("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:t.$$.smartPtrType===this?r=t.$$.smartPtr:w(`Cannot convert argument of type ${t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name} to parameter type ${this.name}`);break;case 1:r=t.$$.smartPtr;break;case 2:if(t.$$.smartPtrType===this)r=t.$$.smartPtr;else{var o=t.clone();r=this.rawShare(r,Ye.toHandle(()=>o.delete())),e!==null&&e.push(this.rawDestructor,r)}break;default:w("Unsupporting sharing policy")}return r}function Xr(e,t){if(t===null)return this.isReference&&w(`null is not a valid ${this.name}`),0;t.$$||w(`Cannot pass "${ze(t)}" as a ${this.name}`),t.$$.ptr||w(`Cannot pass deleted object as a pointer of type ${this.name}`),t.$$.ptrType.isConst&&w(`Cannot convert argument of type ${t.$$.ptrType.name} to parameter type ${this.name}`);var r=t.$$.ptrType.registeredClass,i=we(t.$$.ptr,r,this.registeredClass);return i}function Re(e){return this.fromWireType((g(),F)[e>>2])}var mt=(e,t,r)=>{if(t===r)return e;if(r.baseClass===void 0)return null;var i=mt(e,t,r.baseClass);return i===null?null:r.downcast(i)},jr={},qr=(e,t)=>{for(t===void 0&&w("ptr should not be undefined");e.baseClass;)t=e.upcast(t),e=e.baseClass;return t},Zr=(e,t)=>(t=qr(e,t),jr[t]),Kr=class extends Error{constructor(t){super(t),this.name="InternalError"}},xe=e=>{throw new Kr(e)},Ce=(e,t)=>{(!t.ptrType||!t.ptr)&&xe("makeClassHandle requires ptr and ptrType");var r=!!t.smartPtrType,i=!!t.smartPtr;return r!==i&&xe("Both smartPtrType and smartPtr must be specified"),t.count={value:1},ue(Object.create(e,{$$:{value:t,writable:!0}}))};function Qr(e){var t=this.getPointee(e);if(!t)return this.destructor(e),null;var r=Zr(this.registeredClass,t);if(r!==void 0){if(r.$$.count.value===0)return r.$$.ptr=t,r.$$.smartPtr=e,r.clone();var i=r.clone();return this.destructor(e),i}function o(){return this.isSmartPointer?Ce(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:t,smartPtrType:this,smartPtr:e}):Ce(this.registeredClass.instancePrototype,{ptrType:this,ptr:e})}var l=this.registeredClass.getActualType(t),u=pt[l];if(!u)return o.call(this);var f;this.isConst?f=u.constPointerType:f=u.pointerType;var d=mt(t,this.registeredClass,f.registeredClass);return d===null?o.call(this):this.isSmartPointer?Ce(f.registeredClass.instancePrototype,{ptrType:f,ptr:d,smartPtrType:this,smartPtr:e}):Ce(f.registeredClass.instancePrototype,{ptrType:f,ptr:d})}var Jr=()=>{Object.assign(Ee.prototype,{getPointee(e){return this.rawGetPointee&&(e=this.rawGetPointee(e)),e},destructor(e){this.rawDestructor?.(e)},readValueFromPointer:Re,fromWireType:Qr})};function Ee(e,t,r,i,o,l,u,f,d,b,R){this.name=e,this.registeredClass=t,this.isReference=r,this.isConst=i,this.isSmartPointer=o,this.pointeeType=l,this.sharingPolicy=u,this.rawGetPointee=f,this.rawConstructor=d,this.rawShare=b,this.rawDestructor=R,!o&&t.baseClass===void 0?i?(this.toWireType=Vr,this.destructorFunction=null):(this.toWireType=Xr,this.destructorFunction=null):this.toWireType=Gr}var ei=(e,t,r)=>{a.hasOwnProperty(e)||xe("Replacing nonexistent public symbol"),a[e].overloadTable!==void 0&&r!==void 0||(a[e]=t,a[e].argCount=r)},V=(e,t,r=!1)=>{e=L(e);function i(){var l=oe(t);return l}var o=i();return typeof o!="function"&&w(`unknown function pointer with signature ${e}: ${t}`),o};class ti extends Error{}var ri=e=>{var t=It(e),r=L(t);return G(t),r},he=(e,t)=>{var r=[],i={};function o(l){if(!i[l]&&!J[l]){if(Ae[l]){Ae[l].forEach(o);return}r.push(l),i[l]=!0}}throw t.forEach(o),new ti(`${e}: `+r.map(ri).join([", "]))},K=(e,t,r)=>{e.forEach(f=>Ae[f]=t);function i(f){var d=r(f);d.length!==e.length&&xe("Mismatched type converter count");for(var b=0;b<e.length;++b)H(e[b],d[b])}var o=new Array(t.length),l=[],u=0;for(let[f,d]of t.entries())J.hasOwnProperty(d)?o[f]=J[d]:(l.push(d),Q.hasOwnProperty(d)||(Q[d]=[]),Q[d].push(()=>{o[f]=J[d],++u,u===l.length&&i(o)}));l.length===0&&i(o)},ii=(e,t,r,i,o,l,u,f,d,b,R,P,$)=>{R=L(R),l=V(o,l),f&&=V(u,f),b&&=V(d,b),$=V(P,$);var C=zr(R);Or(C,function(){he(`Cannot construct ${R} due to unbound types`,[i])}),K([e,t,r],i?[i]:[],D=>{D=D[0];var I,Y;i?(I=D.registeredClass,Y=I.instancePrototype):Y=Te.prototype;var W=vt(R,function(...Ke){if(Object.getPrototypeOf(this)!==ge)throw new ce(`Use 'new' to construct ${R}`);if(U.constructor_body===void 0)throw new ce(`${R} has no accessible constructor`);var rr=U.constructor_body[Ke.length];if(rr===void 0)throw new ce(`Tried to invoke ctor of ${R} with invalid number of parameters (${Ke.length}) - expected (${Object.keys(U.constructor_body).toString()}) parameters instead!`);return rr.apply(this,Ke)}),ge=Object.create(Y,{constructor:{value:W}});W.prototype=ge;var U=new Yr(R,W,ge,$,I,l,f,b);U.baseClass&&(U.baseClass.__derivedClasses??=[],U.baseClass.__derivedClasses.push(U));var ns=new Ee(R,U,!0,!1,!1),er=new Ee(R+"*",U,!1,!1,!1),tr=new Ee(R+" const*",U,!1,!0,!1);return pt[e]={pointerType:er,constPointerType:tr},ei(C,W),[ns,er,tr]})},bt=(e,t)=>{for(var r=[],i=0;i<e;i++)r.push((g(),F)[t+i*4>>2]);return r},At=e=>{for(;e.length;){var t=e.pop(),r=e.pop();r(t)}};function Tt(e){for(var t=1;t<e.length;++t)if(e[t]!==null&&e[t].destructorFunction===void 0)return!0;return!1}function si(e,t,r,i){var o=Tt(e),l=e.length-2,u=[],f=["fn"];t&&f.push("thisWired");for(var d=0;d<l;++d)u.push(`arg${d}`),f.push(`arg${d}Wired`);u=u.join(","),f=f.join(",");var b=`return function (${u}) {
`;o&&(b+=`var destructors = [];
`);var R=o?"destructors":"null",P=["humanName","throwBindingError","invoker","fn","runDestructors","fromRetWire","toClassParamWire"];t&&(b+=`var thisWired = toClassParamWire(${R}, this);
`);for(var d=0;d<l;++d){var $=`toArg${d}Wire`;b+=`var arg${d}Wired = ${$}(${R}, arg${d});
`,P.push($)}if(b+=(r||i?"var rv = ":"")+`invoker(${f});
`,o)b+=`runDestructors(destructors);
`;else for(var d=t?1:2;d<e.length;++d){var C=d===1?"thisWired":"arg"+(d-2)+"Wired";e[d].destructorFunction!==null&&(b+=`${C}_dtor(${C});
`,P.push(`${C}_dtor`))}return r&&(b+=`var ret = fromRetWire(rv);
return ret;
`),b+=`}
`,new Function(P,b)}function wt(e,t,r,i,o,l){var u=t.length;u<2&&w("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var f=t[1]!==null&&r!==null,d=Tt(t),b=!t[0].isVoid,R=t[0],P=t[1],$=[e,w,i,o,At,R.fromWireType.bind(R),P?.toWireType.bind(P)],C=2;C<u;++C){var D=t[C];$.push(D.toWireType.bind(D))}if(!d)for(var C=f?1:2;C<t.length;++C)t[C].destructorFunction!==null&&$.push(t[C].destructorFunction);var Y=si(t,f,b,l)(...$);return vt(e,Y)}var ai=(e,t,r,i,o,l)=>{var u=bt(t,r);o=V(i,o),K([],[e],f=>{f=f[0];var d=`constructor ${f.name}`;if(f.registeredClass.constructor_body===void 0&&(f.registeredClass.constructor_body=[]),f.registeredClass.constructor_body[t-1]!==void 0)throw new ce(`Cannot register multiple constructors with identical number of parameters (${t-1}) for class '${f.name}'! Overload resolution is currently only performed using the parameter count, not actual type info!`);return f.registeredClass.constructor_body[t-1]=()=>{he(`Cannot construct ${f.name} due to unbound types`,u)},K([],u,b=>(b.splice(1,0,null),f.registeredClass.constructor_body[t-1]=wt(d,b,null,o,l),[])),[]})},ni=e=>{e=e.trim();const t=e.indexOf("(");return t===-1?e:e.slice(0,t)},oi=(e,t,r,i,o,l,u,f,d,b)=>{var R=bt(r,i);t=L(t),t=ni(t),l=V(o,l,d),K([],[e],P=>{P=P[0];var $=`${P.name}.${t}`;t.startsWith("@@")&&(t=Symbol[t.substring(2)]),f&&P.registeredClass.pureVirtualFunctions.push(t);function C(){he(`Cannot call ${$} due to unbound types`,R)}var D=P.registeredClass.instancePrototype,I=D[t];return I===void 0||I.overloadTable===void 0&&I.className!==P.name&&I.argCount===r-2?(C.argCount=r-2,C.className=P.name,D[t]=C):(yt(D,t,$),D[t].overloadTable[r-2]=C),K([],R,Y=>{var W=wt($,Y,P,l,u,d);return D[t].overloadTable===void 0?(W.argCount=r-2,D[t]=W):D[t].overloadTable[r-2]=W,[]}),[]})},Rt=(e,t,r)=>(e instanceof Object||w(`${r} with invalid "this": ${e}`),e instanceof t.registeredClass.constructor||w(`${r} incompatible with "this" of type ${e.constructor.name}`),e.$$.ptr||w(`cannot call emscripten binding method ${r} on deleted object`),we(e.$$.ptr,e.$$.ptrType.registeredClass,t.registeredClass)),li=(e,t,r,i,o,l,u,f,d,b)=>{t=L(t),o=V(i,o),K([],[e],R=>{R=R[0];var P=`${R.name}.${t}`,$={get(){he(`Cannot access ${P} due to unbound types`,[r,u])},enumerable:!0,configurable:!0};return d?$.set=()=>he(`Cannot access ${P} due to unbound types`,[r,u]):$.set=C=>w(P+" is a read-only property"),Object.defineProperty(R.registeredClass.instancePrototype,t,$),K([],d?[r,u]:[r],C=>{var D=C[0],I={get(){var W=Rt(this,R,P+" getter");return D.fromWireType(o(l,W))},enumerable:!0};if(d){d=V(f,d);var Y=C[1];I.set=function(W){var ge=Rt(this,R,P+" setter"),U=[];d(b,ge,Y.toWireType(U,W)),At(U)}}return Object.defineProperty(R.registeredClass.instancePrototype,t,I),[]}),[]})},xt=[],ee=[0,1,,1,null,1,!0,1,!1,1],ci=e=>{e>9&&--ee[e+1]===0&&(ee[e]=void 0,xt.push(e))},Ye={toValue:e=>(e||w(`Cannot use deleted val. handle = ${e}`),ee[e]),toHandle:e=>{switch(e){case void 0:return 2;case null:return 4;case!0:return 6;case!1:return 8;default:{const t=xt.pop()||ee.length;return ee[t]=e,ee[t+1]=1,t}}}},ui={name:"emscripten::val",fromWireType:e=>{var t=Ye.toValue(e);return ci(e),t},toWireType:(e,t)=>Ye.toHandle(t),readValueFromPointer:Re,destructorFunction:null},hi=e=>H(e,ui),fi=(e,t)=>{switch(t){case 4:return function(r){return this.fromWireType((g(),se)[r>>2])};case 8:return function(r){return this.fromWireType((g(),q)[r>>3])};default:throw new TypeError(`invalid float width (${t}): ${e}`)}},di=(e,t,r)=>{t=L(t),H(e,{name:t,fromWireType:i=>i,toWireType:(i,o)=>o,readValueFromPointer:fi(t,r),destructorFunction:null})},gi=(e,t,r,i,o)=>{t=L(t);const l=i===0;let u=d=>d;if(l){var f=32-8*r;u=d=>d<<f>>>f,o=u(o)}H(e,{name:t,fromWireType:u,toWireType:(d,b)=>b,readValueFromPointer:dt(t,r,i!==0),destructorFunction:null})},_i=(e,t,r)=>{var i=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,BigInt64Array,BigUint64Array],o=i[t];function l(u){var f=(g(),F)[u>>2],d=(g(),F)[u+4>>2];return new o((g(),M).buffer,d,f)}r=L(r),H(e,{name:r,fromWireType:l,readValueFromPointer:l},{ignoreDuplicateRegistrations:!0})},vi=(e,t,r,i)=>{if(!(i>0))return 0;for(var o=r,l=r+i-1,u=0;u<e.length;++u){var f=e.codePointAt(u);if(f<=127){if(r>=l)break;t[r++]=f}else if(f<=2047){if(r+1>=l)break;t[r++]=192|f>>6,t[r++]=128|f&63}else if(f<=65535){if(r+2>=l)break;t[r++]=224|f>>12,t[r++]=128|f>>6&63,t[r++]=128|f&63}else{if(r+3>=l)break;t[r++]=240|f>>18,t[r++]=128|f>>12&63,t[r++]=128|f>>6&63,t[r++]=128|f&63,u++}}return t[r]=0,r-o},Ct=(e,t,r)=>vi(e,(g(),S),t,r),Et=e=>{for(var t=0,r=0;r<e.length;++r){var i=e.charCodeAt(r);i<=127?t++:i<=2047?t+=2:i>=55296&&i<=57343?(t+=4,++r):t+=3}return t},pi=(e,t)=>{t=L(t),H(e,{name:t,fromWireType(r){var i=(g(),F)[r>>2],o=r+4,l;return l=le(o,i,!0),G(r),l},toWireType(r,i){i instanceof ArrayBuffer&&(i=new Uint8Array(i));var o,l=typeof i=="string";l||ArrayBuffer.isView(i)&&i.BYTES_PER_ELEMENT==1||w("Cannot pass non-string to std::string"),l?o=Et(i):o=i.length;var u=je(4+o+1),f=u+4;return(g(),F)[u>>2]=o,l?Ct(i,f,o+1):(g(),S).set(i,f),r!==null&&r.push(G,u),u},readValueFromPointer:Re,destructorFunction(r){G(r)}})},yi=new TextDecoder("utf-16le"),mi=(e,t,r)=>{var i=e>>1,o=Oe((g(),j),i,t/2,r);return yi.decode((g(),j).slice(i,o))},bi=(e,t,r)=>{if(r??=2147483647,r<2)return 0;r-=2;for(var i=t,o=r<e.length*2?r/2:e.length,l=0;l<o;++l){var u=e.charCodeAt(l);(g(),X)[t>>1]=u,t+=2}return(g(),X)[t>>1]=0,t-i},Ai=e=>e.length*2,Ti=(e,t,r)=>{for(var i="",o=e>>2,l=0;!(l>=t/4);l++){var u=(g(),F)[o+l];if(!u&&!r)break;i+=String.fromCodePoint(u)}return i},wi=(e,t,r)=>{if(r??=2147483647,r<4)return 0;for(var i=t,o=i+r-4,l=0;l<e.length;++l){var u=e.codePointAt(l);if(u>65535&&l++,(g(),z)[t>>2]=u,t+=4,t+4>o)break}return(g(),z)[t>>2]=0,t-i},Ri=e=>{for(var t=0,r=0;r<e.length;++r){var i=e.codePointAt(r);i>65535&&r++,t+=4}return t},xi=(e,t,r)=>{r=L(r);var i,o,l;t===2?(i=mi,o=bi,l=Ai):(i=Ti,o=wi,l=Ri),H(e,{name:r,fromWireType:u=>{var f=(g(),F)[u>>2],d=i(u+4,f*t,!0);return G(u),d},toWireType:(u,f)=>{typeof f!="string"&&w(`Cannot pass non-string to C++ string type ${r}`);var d=l(f),b=je(4+d+t);return(g(),F)[b>>2]=d/t,o(f,b+4,d+t),u!==null&&u.push(G,b),b},readValueFromPointer:Re,destructorFunction(u){G(u)}})},Ci=(e,t)=>{t=L(t),H(e,{isVoid:!0,name:t,fromWireType:()=>{},toWireType:(r,i)=>{}})},Ei=e=>{Ze(e,!p,1,!1,65536,!1),T.threadInitTLS()},Ve=e=>{e()},Pi=!Atomics.waitAsync||globalThis.navigator?.userAgent&&Number((navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)||[])[2])<91,Ge=e=>{if(!Pi){var t=Atomics.waitAsync((g(),z),e>>2,e);t.value.then(Pe);var r=e+128;Atomics.store((g(),z),r>>2,1)}},Pe=()=>Ve(()=>{var e=qe();e&&(Ge(e),Vt())}),Fi=(e,t)=>{if(e==t)setTimeout(Pe);else if(_)postMessage({targetThread:e,cmd:"checkMailbox"});else{var r=T.pthreads[e];if(!r)return;r.postMessage({cmd:"checkMailbox"})}},Fe=[],Si=(e,t,r,i,o)=>{i/=2,Fe.length=i;for(var l=o>>3,u=0;u<i;u++)(g(),N)[l+2*u]?Fe[u]=(g(),N)[l+2*u+1]:Fe[u]=(g(),q)[l+2*u+1];var f=Ji[e];T.currentProxiedOperationCallerThread=r;var d=f(...Fe);return T.currentProxiedOperationCallerThread=0,d},$i=()=>{},Di=e=>{_?postMessage({cmd:"cleanupThread",thread:e}):me(e)},Mi=e=>{},Bi=()=>{throw 1/0},fe={},Pt=()=>performance.timeOrigin+performance.now();function Ft(e,t){if(_)return B(6,0,1,e,t);if(fe[e]&&(clearTimeout(fe[e].id),delete fe[e]),!t)return 0;var r=setTimeout(()=>{delete fe[e],Ve(()=>Yt(e,Pt()))},t);return fe[e]={id:r,timeout_ms:t},0}var Li=()=>Date.now(),Ui=9007199254740992,ki=-9007199254740992,Ii=e=>e<ki||e>Ui?NaN:Number(e),Wi=()=>{},Oi=e=>h(le(e)),Ni=()=>{throw"unwind"},St=()=>2147483648,Hi=()=>St(),zi=()=>navigator.hardwareConcurrency,Yi=(e,t)=>Math.ceil(e/t)*t,Vi=e=>{var t=O.buffer.byteLength,r=(e-t+65535)/65536|0;try{return O.grow(r),Z(),1}catch{}},Gi=e=>{var t=(g(),S).length;if(e>>>=0,e<=t)return!1;var r=St();if(e>r)return!1;for(var i=1;i<=4;i*=2){var o=t*(1+.2/i);o=Math.min(o,e+100663296);var l=Math.min(r,Yi(Math.max(e,o),65536)),u=Vi(l);if(u)return!0}return!1},Xe={},Xi=()=>"./this.program",de=()=>{if(!de.strings){var e=(globalThis.navigator?.language??"C").replace("-","_")+".UTF-8",t={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:e,_:Xi()};for(var r in Xe)Xe[r]===void 0?delete t[r]:t[r]=Xe[r];var i=[];for(var r in t)i.push(`${r}=${t[r]}`);de.strings=i}return de.strings};function $t(e,t){if(_)return B(7,0,1,e,t);var r=0,i=0;for(var o of de()){var l=t+r;(g(),F)[e+i>>2]=l,r+=Ct(o,l,1/0)+1,i+=4}return 0}function Dt(e,t){if(_)return B(8,0,1,e,t);var r=de();(g(),F)[e>>2]=r.length;var i=0;for(var o of r)i+=Et(o)+1;return(g(),F)[t>>2]=i,0}function Mt(e){return _?B(9,0,1,e):52}function Bt(e,t,r,i){return _?B(10,0,1,e,t,r,i):52}function Lt(e,t,r,i){return _?B(11,0,1,e,t,r,i):(t=Ii(t),70)}var ji=[null,[],[]],qi=(e,t=0,r,i)=>{var o=Oe(e,t,r,i);return nt.decode(e.buffer?e.buffer instanceof ArrayBuffer?e.subarray(t,o):e.slice(t,o):new Uint8Array(e.slice(t,o)))},Zi=(e,t)=>{var r=ji[e];t===0||t===10?((e===1?c:h)(qi(r)),r.length=0):r.push(t)};function Ut(e,t,r,i){if(_)return B(12,0,1,e,t,r,i);for(var o=0,l=0;l<r;l++){var u=(g(),F)[t>>2],f=(g(),F)[t+4>>2];t+=8;for(var d=0;d<f;d++)Zi(e,(g(),S)[u+d]);o+=f}return(g(),F)[i>>2]=o,0}var Ki=()=>e=>e.set(crypto.getRandomValues(new Uint8Array(e.byteLength))),kt=e=>{(kt=Ki())(e)},Qi=(e,t)=>(kt((g(),S).subarray(e,e+t)),0);T.init(),Wr(),Jr();var Ji=[We,ot,ct,ut,ht,ft,Ft,$t,Dt,Mt,Bt,Lt,Ut],je,G,It,Wt,qe,Ze,Ot,Nt,Ht,zt,Yt,Vt,Se,Gt,Xt,jt,qt,Zt;function es(e){a.__ZdlPvm=e.Z,je=a._malloc=e._,G=e.$,a._calloc=e.aa,It=e.ba,Wt=e.ca,qe=e.da,a._emscripten_builtin_free=e.ea,e.fa,Ze=e.ha,Ot=e.ia,a.___libc_free=e.ja,a._emscripten_builtin_malloc=e.ka,a.___libc_malloc=e.la,Nt=e.ma,Ht=e.na,zt=e.oa,Yt=e.pa,Vt=e.qa,a.__ZdaPv=e.ra,a.__ZdaPvm=e.sa,a.__ZdlPv=e.ta,a.__Znaj=e.ua,a.__ZnajSt11align_val_t=e.va,a.__Znwj=e.wa,a.__ZnwjSt11align_val_t=e.xa,a.___libc_calloc=e.ya,a.___libc_realloc=e.za,a._emscripten_builtin_calloc=e.Aa,a._emscripten_builtin_realloc=e.Ba,a._malloc_size=e.Ca,a._malloc_usable_size=e.Da,a._reallocf=e.Ea,Se=e.Fa,Gt=e.Ga,Xt=e.Ha,jt=e.Ia,qt=e.Ja,Zt=e.ga}var Kt;function ts(){Kt={b:$r,K:lt,p:ct,J:ut,T:ht,q:ft,F:Mr,s:Lr,u:Ur,k:ii,U:ai,d:oi,c:li,X:hi,r:di,g:gi,e:_i,t:pi,l:xi,v:Ci,O:Ei,G:Fi,L:Si,B:$i,n:Di,N:Ge,W:Mi,z:Bi,C:Ft,o:Wi,f:Li,m:Oi,V:Ni,H:Hi,h:Pt,I:zi,D:Gi,P:$t,Q:Dt,i:Pr,j:Mt,S:Bt,M:Lt,R:Ut,y:rs,w:ss,x:is,a:O,A:We,E:Qi}}function rs(e,t,r){var i=be();try{return oe(e)(t,r)}catch(o){if(ne(i),o!==o+0)throw o;Se(1,0)}}function is(e,t,r,i,o){var l=be();try{return oe(e)(t,r,i,o)}catch(u){if(ne(l),u!==u+0)throw u;Se(1,0)}}function ss(e,t,r,i){var o=be();try{return oe(e)(t,r,i)}catch(l){if(ne(o),l!==l+0)throw l;Se(1,0)}}function as(e){pe=!0,T.tlsInitFunctions.push(e.fa),!_&&e.Y()}var Qt;function Jt(){ts();var e={a:Kt};WebAssembly.instantiateStreaming(fetch("jassub-worker.wasm"),e).then(t=>{var r=(t.instance||t).exports;Qt=t.module||a.wasm,es(r),xr(Cr),as(r),T.loadWasmModuleToAllWorkers().then(v)})}return _||Jt(),pe?s=a:s=new Promise((e,t)=>{y=e}),s}var bs=globalThis.self?.name?.startsWith("em-pthread");bs&&Ar();class or{canvas=null;ctx=null;bufferCanvas=new OffscreenCanvas(1,1);bufferCtx=this.bufferCanvas.getContext("2d",{alpha:!0,desynchronized:!0,willReadFrequently:!1});_scheduledResize;resizeCanvas(s,a){s<=0||a<=0||(this._scheduledResize={width:s,height:a})}setCanvas(s){if(this.canvas=s,this.ctx=s.getContext("2d",{alpha:!0,desynchronized:!0,willReadFrequently:!1}),!this.ctx)throw new Error("Could not get 2D context")}setColorMatrix(s,a){}render(s,a){if(!(!this.ctx||!this.canvas)){if(this._scheduledResize){const{width:c,height:h}=this._scheduledResize;this._scheduledResize=void 0,this.canvas.width=c,this.canvas.height=h}else this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(const c of s){if(c.w<=0||c.h<=0)continue;const h=new ImageData(c.w,c.h),v=new Uint32Array(h.data.buffer),p=c.color<<8&16711680|c.color>>8&65280|c.color>>24&255,_=(255-(c.color&255))/255,A=c.stride,m=c.h,g=c.w;for(let y=m+1,x=c.bitmap,E=0;--y;x+=A)for(let M=0;M<g;++M,++E){const S=a[x+M];S!==0&&(v[E]=_*S<<24|p)}this.bufferCanvas.width=g,this.bufferCanvas.height=m,this.bufferCtx.putImageData(h,0,0),this.ctx.drawImage(this.bufferCanvas,c.dst_x,c.dst_y)}}}destroy(){this.ctx=null,this.canvas=null,this.bufferCtx=null,this.bufferCanvas=null}}const lr=["thin","extralight","light","regular","medium","semibold","bold","extrabold","black","ultrablack"],it=navigator.userAgent.toLowerCase().includes("firefox"),Je="BT601",cr="BT709",ur="SMPTE240M",hr="FCC",fr=[null,Je,null,Je,Je,cr,cr,ur,ur,hr,hr];function De(n,s){for(const a of Object.keys(n))s[a]=n[a]}const Tr=globalThis.fetch;async function dr(n){return await(await Tr(n)).text()}const wr=!it&&self.crossOriginIsolated?Math.min(Math.max(1,navigator.hardwareConcurrency-2),8):1,As=!!WebAssembly.Memory.prototype.toResizableBuffer,Ts=!it&&(As||wr>1),ie=new Float32Array([1,0,0,0,1,0,0,0,1]),Rr={BT601:{BT709:new Float32Array([1.0863,.0965,-.01411,-.0723,.8451,-.0277,-.0141,.0584,1.0418]),BT601:ie},BT709:{BT601:new Float32Array([.9137,.0784,.0079,-.1049,1.1722,-.0671,.0096,.0322,.9582]),BT709:ie},FCC:{BT709:new Float32Array([1.0873,-.0736,-.0137,.0974,.8494,.0531,-.0127,-.0251,1.0378]),BT601:new Float32Array([1.001,-8e-4,-2e-4,9e-4,1.005,-.006,.0013,.0027,.996])},SMPTE240M:{BT709:new Float32Array([.9993,6e-4,1e-4,-4e-4,.9812,.0192,-.0034,-.0114,1.0148]),BT601:new Float32Array([.913,.0774,.0096,-.1051,1.1508,-.0456,.0063,.0207,.973])}},ws=`
precision mediump float;

// Quad position attribute (0,0), (1,0), (0,1), (1,0), (1,1), (0,1)
attribute vec2 a_quadPos;

uniform vec2 u_resolution;

// Instance attributes
attribute vec4 a_destRect;  // x, y, w, h
attribute vec4 a_color;     // r, g, b, a
attribute float a_texLayer;

varying vec2 v_destXY;
varying vec4 v_color;
varying vec2 v_texSize;
varying float v_texLayer;
varying vec2 v_texCoord;

void main() {
  vec2 pixelPos = a_destRect.xy + a_quadPos * a_destRect.zw;
  vec2 clipPos = (pixelPos / u_resolution) * 2.0 - 1.0;
  clipPos.y = -clipPos.y;

  gl_Position = vec4(clipPos, 0.0, 1.0);
  v_destXY = a_destRect.xy;
  v_color = a_color;
  v_texSize = a_destRect.zw;
  v_texLayer = a_texLayer;
  v_texCoord = a_quadPos;
}
`,Rs=`
precision mediump float;

uniform sampler2D u_tex;
uniform mat3 u_colorMatrix;
uniform vec2 u_resolution;
uniform vec2 u_texDimensions; // Actual texture dimensions

varying vec2 v_destXY;
varying vec4 v_color;
varying vec2 v_texSize;
varying float v_texLayer;
varying vec2 v_texCoord;

void main() {
  // v_texCoord is in 0-1 range for the quad
  // We need to map it to the actual image size within the texture
  // The image occupies only (v_texSize.x / u_texDimensions.x, v_texSize.y / u_texDimensions.y) of the texture
  vec2 normalizedImageSize = v_texSize / u_texDimensions;
  vec2 texCoord = v_texCoord * normalizedImageSize;

  // Sample texture (r channel contains mask)
  float mask = texture2D(u_tex, texCoord).r;

  // Apply color matrix conversion (identity if no conversion needed)
  vec3 correctedColor = u_colorMatrix * v_color.rgb;

  // libass color alpha: 0 = opaque, 255 = transparent (inverted)
  float colorAlpha = 1.0 - v_color.a;

  // Final alpha = colorAlpha * mask
  float a = colorAlpha * mask;

  // Premultiplied alpha output
  gl_FragColor = vec4(correctedColor * a, a);
}
`,et=256;class xs{canvas=null;gl=null;program=null;instancedArraysExt=null;u_resolution=null;u_tex=null;u_colorMatrix=null;u_texDimensions=null;a_quadPos=-1;a_destRect=-1;a_color=-1;a_texLayer=-1;quadPosBuffer=null;instanceDestRectBuffer=null;instanceColorBuffer=null;instanceTexLayerBuffer=null;instanceDestRectData;instanceColorData;instanceTexLayerData;textureCache=new Map;textureWidth=0;textureHeight=0;colorMatrix=ie;constructor(){this.instanceDestRectData=new Float32Array(et*4),this.instanceColorData=new Float32Array(et*4),this.instanceTexLayerData=new Float32Array(et)}_scheduledResize;resizeCanvas(s,a){s<=0||a<=0||(this._scheduledResize={width:s,height:a})}setCanvas(s){if(this.canvas=s,this.gl=s.getContext("webgl",{alpha:!0,premultipliedAlpha:!0,antialias:!1,depth:!1,preserveDrawingBuffer:!1,stencil:!1,desynchronized:!0,powerPreference:"high-performance"}),!this.gl)throw new Error("Could not get WebGL context");if(this.instancedArraysExt=this.gl.getExtension("ANGLE_instanced_arrays"),!this.instancedArraysExt)throw new Error("ANGLE_instanced_arrays extension not supported");const a=this.createShader(this.gl.VERTEX_SHADER,ws),c=this.createShader(this.gl.FRAGMENT_SHADER,Rs);if(!a||!c)throw new Error("Failed to create shaders");if(this.program=this.gl.createProgram(),this.gl.attachShader(this.program,a),this.gl.attachShader(this.program,c),this.gl.linkProgram(this.program),!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS)){const v=this.gl.getProgramInfoLog(this.program);throw new Error("Failed to link program: "+v)}this.u_resolution=this.gl.getUniformLocation(this.program,"u_resolution"),this.u_tex=this.gl.getUniformLocation(this.program,"u_tex"),this.u_colorMatrix=this.gl.getUniformLocation(this.program,"u_colorMatrix"),this.u_texDimensions=this.gl.getUniformLocation(this.program,"u_texDimensions"),this.a_quadPos=this.gl.getAttribLocation(this.program,"a_quadPos"),this.a_destRect=this.gl.getAttribLocation(this.program,"a_destRect"),this.a_color=this.gl.getAttribLocation(this.program,"a_color"),this.a_texLayer=this.gl.getAttribLocation(this.program,"a_texLayer"),this.quadPosBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quadPosBuffer);const h=new Float32Array([0,0,1,0,0,1,1,0,1,1,0,1]);this.gl.bufferData(this.gl.ARRAY_BUFFER,h,this.gl.STATIC_DRAW),this.instanceDestRectBuffer=this.gl.createBuffer(),this.instanceColorBuffer=this.gl.createBuffer(),this.instanceTexLayerBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quadPosBuffer),this.gl.enableVertexAttribArray(this.a_quadPos),this.gl.vertexAttribPointer(this.a_quadPos,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.instanceDestRectBuffer),this.gl.enableVertexAttribArray(this.a_destRect),this.gl.vertexAttribPointer(this.a_destRect,4,this.gl.FLOAT,!1,0,0),this.instancedArraysExt.vertexAttribDivisorANGLE(this.a_destRect,1),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.instanceColorBuffer),this.gl.enableVertexAttribArray(this.a_color),this.gl.vertexAttribPointer(this.a_color,4,this.gl.FLOAT,!1,0,0),this.instancedArraysExt.vertexAttribDivisorANGLE(this.a_color,1),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.instanceTexLayerBuffer),this.gl.enableVertexAttribArray(this.a_texLayer),this.gl.vertexAttribPointer(this.a_texLayer,1,this.gl.FLOAT,!1,0,0),this.instancedArraysExt.vertexAttribDivisorANGLE(this.a_texLayer,1),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.useProgram(this.program),this.gl.uniform1i(this.u_tex,0),this.gl.uniformMatrix3fv(this.u_colorMatrix,!1,this.colorMatrix),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1),this.gl.clearColor(0,0,0,0),this.gl.activeTexture(this.gl.TEXTURE0)}createShader(s,a){const c=this.gl.createShader(s);if(this.gl.shaderSource(c,a),this.gl.compileShader(c),!this.gl.getShaderParameter(c,this.gl.COMPILE_STATUS)){const h=this.gl.getShaderInfoLog(c);return console.log(h),this.gl.deleteShader(c),null}return c}setColorMatrix(s,a){this.colorMatrix=(s&&a&&Rr[s]?.[a])??ie,this.gl&&this.u_colorMatrix&&this.program&&(this.gl.useProgram(this.program),this.gl.uniformMatrix3fv(this.u_colorMatrix,!1,this.colorMatrix))}createTexture(s,a){const c=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,c),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.LUMINANCE,s,a,0,this.gl.LUMINANCE,this.gl.UNSIGNED_BYTE,null),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),c}render(s,a){if(!this.gl||!this.program||!this.instancedArraysExt)return;if(this._scheduledResize){const{width:p,height:_}=this._scheduledResize;this._scheduledResize=void 0,this.canvas.width=p,this.canvas.height=_,this.gl.viewport(0,0,p,_),this.gl.uniform2f(this.u_resolution,p,_)}else this.gl.clear(this.gl.COLOR_BUFFER_BIT);let c=this.textureWidth,h=this.textureHeight;const v=[];for(const p of s)p.w<=0||p.h<=0||(v.push(p),p.w>c&&(c=p.w),p.h>h&&(h=p.h));if(v.length!==0){if(c>this.textureWidth||h>this.textureHeight){this.textureWidth=c,this.textureHeight=h;for(const p of this.textureCache.values())this.gl.deleteTexture(p);this.textureCache.clear()}for(let p=0;p<v.length;p++){const _=v[p];let A=this.textureCache.get(p);A||(A=this.createTexture(this.textureWidth,this.textureHeight),this.textureCache.set(p,A)),this.gl.bindTexture(this.gl.TEXTURE_2D,A);const m=new Uint8Array(a.buffer,_.bitmap,_.stride*_.h),g=new Uint8Array(_.w*_.h);for(let y=0;y<_.h;y++){const x=y*_.stride,E=y*_.w;g.set(m.subarray(x,x+_.w),E)}this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,0,0,_.w,_.h,this.gl.LUMINANCE,this.gl.UNSIGNED_BYTE,g),this.instanceDestRectData[0]=_.dst_x,this.instanceDestRectData[1]=_.dst_y,this.instanceDestRectData[2]=_.w,this.instanceDestRectData[3]=_.h,this.instanceColorData[0]=(_.color>>>24&255)/255,this.instanceColorData[1]=(_.color>>>16&255)/255,this.instanceColorData[2]=(_.color>>>8&255)/255,this.instanceColorData[3]=(_.color&255)/255,this.instanceTexLayerData[0]=0,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.instanceDestRectBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.instanceDestRectData.subarray(0,4),this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.instanceColorBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.instanceColorData.subarray(0,4),this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.instanceTexLayerBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.instanceTexLayerData.subarray(0,1),this.gl.DYNAMIC_DRAW),this.gl.uniform2f(this.u_texDimensions,this.textureWidth,this.textureHeight),this.instancedArraysExt.drawArraysInstancedANGLE(this.gl.TRIANGLES,0,6,1)}}}destroy(){if(this.gl){for(const s of this.textureCache.values())this.gl.deleteTexture(s);this.textureCache.clear(),this.quadPosBuffer&&(this.gl.deleteBuffer(this.quadPosBuffer),this.quadPosBuffer=null),this.instanceDestRectBuffer&&(this.gl.deleteBuffer(this.instanceDestRectBuffer),this.instanceDestRectBuffer=null),this.instanceColorBuffer&&(this.gl.deleteBuffer(this.instanceColorBuffer),this.instanceColorBuffer=null),this.instanceTexLayerBuffer&&(this.gl.deleteBuffer(this.instanceTexLayerBuffer),this.instanceTexLayerBuffer=null),this.program&&(this.gl.deleteProgram(this.program),this.program=null),this.gl=null}}}const Cs=`#version 300 es
precision mediump float;

const vec2 QUAD_POSITIONS[6] = vec2[6](
  vec2(0.0, 0.0),
  vec2(1.0, 0.0),
  vec2(0.0, 1.0),
  vec2(1.0, 0.0),
  vec2(1.0, 1.0),
  vec2(0.0, 1.0)
);

uniform vec2 u_resolution;

// Instance attributes
in vec4 a_destRect;  // x, y, w, h
in vec4 a_color;     // r, g, b, a
in float a_texLayer;

flat out vec2 v_destXY;
flat out vec4 v_color;
flat out vec2 v_texSize;
flat out float v_texLayer;

void main() {
  vec2 quadPos = QUAD_POSITIONS[gl_VertexID];
  vec2 pixelPos = a_destRect.xy + quadPos * a_destRect.zw;
  vec2 clipPos = (pixelPos / u_resolution) * 2.0 - 1.0;
  clipPos.y = -clipPos.y;

  gl_Position = vec4(clipPos, 0.0, 1.0);
  v_destXY = a_destRect.xy;
  v_color = a_color;
  v_texSize = a_destRect.zw;
  v_texLayer = a_texLayer;
}
`,Es=`#version 300 es
precision mediump float;
precision mediump sampler2DArray;

uniform sampler2DArray u_texArray;
uniform mat3 u_colorMatrix;
uniform vec2 u_resolution;

flat in vec2 v_destXY;
flat in vec4 v_color;
flat in vec2 v_texSize;
flat in float v_texLayer;

out vec4 fragColor;

void main() {
  // Flip Y: WebGL's gl_FragCoord.y is 0 at bottom, but destXY.y is from top
  vec2 fragPos = vec2(gl_FragCoord.x, u_resolution.y - gl_FragCoord.y);

  // Calculate local position within the quad (screen coords)
  vec2 localPos = fragPos - v_destXY;

  // Convert to integer texel coordinates for texelFetch
  ivec2 texCoord = ivec2(floor(localPos));

  // Bounds check (prevents out-of-bounds access)
  ivec2 texSizeI = ivec2(v_texSize);
  if (texCoord.x < 0 || texCoord.y < 0 || texCoord.x >= texSizeI.x || texCoord.y >= texSizeI.y) {
    discard;
  }

  // texelFetch: integer coords, no interpolation, no precision issues
  float mask = texelFetch(u_texArray, ivec3(texCoord, int(v_texLayer)), 0).r;

  // Apply color matrix conversion (identity if no conversion needed)
  vec3 correctedColor = u_colorMatrix * v_color.rgb;

  // libass color alpha: 0 = opaque, 255 = transparent (inverted)
  float colorAlpha = 1.0 - v_color.a;

  // Final alpha = colorAlpha * mask
  float a = colorAlpha * mask;

  // Premultiplied alpha output
  fragColor = vec4(correctedColor * a, a);
}
`,gr=64,_r=256,Me=256;class Ps{canvas=null;gl=null;program=null;vao=null;u_resolution=null;u_texArray=null;u_colorMatrix=null;instanceDestRectBuffer=null;instanceColorBuffer=null;instanceTexLayerBuffer=null;instanceDestRectData;instanceColorData;instanceTexLayerData;texArray=null;texArrayWidth=0;texArrayHeight=0;colorMatrix=ie;constructor(){this.instanceDestRectData=new Float32Array(Me*4),this.instanceColorData=new Float32Array(Me*4),this.instanceTexLayerData=new Float32Array(Me)}_scheduledResize;resizeCanvas(s,a){s<=0||a<=0||(this._scheduledResize={width:s,height:a})}setCanvas(s){if(this.canvas=s,this.gl=s.getContext("webgl2",{alpha:!0,premultipliedAlpha:!0,antialias:!1,depth:!1,preserveDrawingBuffer:!1,stencil:!1,desynchronized:!0,powerPreference:"high-performance"}),!this.gl)throw new Error("Could not get WebGL2 context");const a=this.createShader(this.gl.VERTEX_SHADER,Cs),c=this.createShader(this.gl.FRAGMENT_SHADER,Es);if(!a||!c)throw new Error("Failed to create shaders");if(this.program=this.gl.createProgram(),this.gl.attachShader(this.program,a),this.gl.attachShader(this.program,c),this.gl.linkProgram(this.program),!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS)){const _=this.gl.getProgramInfoLog(this.program);throw new Error("Failed to link program: "+_)}this.gl.deleteShader(a),this.gl.deleteShader(c),this.u_resolution=this.gl.getUniformLocation(this.program,"u_resolution"),this.u_texArray=this.gl.getUniformLocation(this.program,"u_texArray"),this.u_colorMatrix=this.gl.getUniformLocation(this.program,"u_colorMatrix"),this.instanceDestRectBuffer=this.gl.createBuffer(),this.instanceColorBuffer=this.gl.createBuffer(),this.instanceTexLayerBuffer=this.gl.createBuffer(),this.vao=this.gl.createVertexArray(),this.gl.bindVertexArray(this.vao);const h=this.gl.getAttribLocation(this.program,"a_destRect");this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.instanceDestRectBuffer),this.gl.enableVertexAttribArray(h),this.gl.vertexAttribPointer(h,4,this.gl.FLOAT,!1,0,0),this.gl.vertexAttribDivisor(h,1);const v=this.gl.getAttribLocation(this.program,"a_color");this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.instanceColorBuffer),this.gl.enableVertexAttribArray(v),this.gl.vertexAttribPointer(v,4,this.gl.FLOAT,!1,0,0),this.gl.vertexAttribDivisor(v,1);const p=this.gl.getAttribLocation(this.program,"a_texLayer");this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.instanceTexLayerBuffer),this.gl.enableVertexAttribArray(p),this.gl.vertexAttribPointer(p,1,this.gl.FLOAT,!1,0,0),this.gl.vertexAttribDivisor(p,1),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.useProgram(this.program),this.gl.uniform1i(this.u_texArray,0),this.gl.uniformMatrix3fv(this.u_colorMatrix,!1,this.colorMatrix),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1),this.gl.clearColor(0,0,0,0),this.gl.activeTexture(this.gl.TEXTURE0),this.createTexArray(_r,_r)}createShader(s,a){const c=this.gl.createShader(s);if(this.gl.shaderSource(c,a),this.gl.compileShader(c),!this.gl.getShaderParameter(c,this.gl.COMPILE_STATUS)){const h=this.gl.getShaderInfoLog(c);return console.log(h),this.gl.deleteShader(c),null}return c}setColorMatrix(s,a){this.colorMatrix=(s&&a&&Rr[s]?.[a])??ie,this.gl&&this.u_colorMatrix&&this.program&&(this.gl.useProgram(this.program),this.gl.uniformMatrix3fv(this.u_colorMatrix,!1,this.colorMatrix))}createTexArray(s,a){this.texArray&&this.gl.deleteTexture(this.texArray),this.texArray=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D_ARRAY,this.texArray),this.gl.texImage3D(this.gl.TEXTURE_2D_ARRAY,0,this.gl.R8,s,a,gr,0,this.gl.RED,this.gl.UNSIGNED_BYTE,null),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D_ARRAY,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.texArrayWidth=s,this.texArrayHeight=a}render(s,a){if(!this.gl||!this.program||!this.vao||!this.texArray)return;if((self.HEAPU8RAW.buffer!==self.WASMMEMORY.buffer||Ts)&&(a=self.HEAPU8RAW=new Uint8Array(self.WASMMEMORY.buffer)),this._scheduledResize){const{width:_,height:A}=this._scheduledResize;this._scheduledResize=void 0,this.canvas.width=_,this.canvas.height=A,this.gl.viewport(0,0,_,A),this.gl.uniform2f(this.u_resolution,_,A)}else this.gl.clear(this.gl.COLOR_BUFFER_BIT);let c=this.texArrayWidth,h=this.texArrayHeight;const v=[];for(const _ of s)_.w<=0||_.h<=0||(v.push(_),_.w>c&&(c=_.w),_.h>h&&(h=_.h));if(v.length===0)return;(c>this.texArrayWidth||h>this.texArrayHeight)&&this.createTexArray(c,h);const p=Math.min(gr,Me);for(let _=0;_<v.length;_+=p){const A=Math.min(_+p,v.length);let m=0;for(let g=_;g<A;g++){const y=v[g],x=m;if(this.gl.pixelStorei(this.gl.UNPACK_ROW_LENGTH,y.stride),it){const M=new Uint8Array(a.buffer,y.bitmap,y.stride*y.h),S=new Uint8Array(M);this.gl.texSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,x,y.w,y.h,1,this.gl.RED,this.gl.UNSIGNED_BYTE,S)}else this.gl.texSubImage3D(this.gl.TEXTURE_2D_ARRAY,0,0,0,x,y.w,y.h,1,this.gl.RED,this.gl.UNSIGNED_BYTE,a,y.bitmap);const E=m*4;this.instanceDestRectData[E]=y.dst_x,this.instanceDestRectData[E+1]=y.dst_y,this.instanceDestRectData[E+2]=y.w,this.instanceDestRectData[E+3]=y.h,this.instanceColorData[E]=(y.color>>>24&255)/255,this.instanceColorData[E+1]=(y.color>>>16&255)/255,this.instanceColorData[E+2]=(y.color>>>8&255)/255,this.instanceColorData[E+3]=(y.color&255)/255,this.instanceTexLayerData[m]=x,m++}this.gl.pixelStorei(this.gl.UNPACK_ROW_LENGTH,0),m!==0&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.instanceDestRectBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.instanceDestRectData.subarray(0,m*4),this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.instanceColorBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.instanceColorData.subarray(0,m*4),this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.instanceTexLayerBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.instanceTexLayerData.subarray(0,m),this.gl.DYNAMIC_DRAW),this.gl.drawArraysInstanced(this.gl.TRIANGLES,0,6,m))}}destroy(){this.gl&&(this.texArray&&(this.gl.deleteTexture(this.texArray),this.texArray=null),this.instanceDestRectBuffer&&(this.gl.deleteBuffer(this.instanceDestRectBuffer),this.instanceDestRectBuffer=null),this.instanceColorBuffer&&(this.gl.deleteBuffer(this.instanceColorBuffer),this.instanceColorBuffer=null),this.instanceTexLayerBuffer&&(this.gl.deleteBuffer(this.instanceTexLayerBuffer),this.instanceTexLayerBuffer=null),this.vao&&(this.gl.deleteVertexArray(this.vao),this.vao=null),this.program&&(this.gl.deleteProgram(this.program),this.program=null),this.gl=null)}}class Fs{_offCanvas;_wasm;_subtitleColorSpace;_videoColorSpace;_malloc;_gpurender;debug=!1;_ready;constructor(s,a){this._availableFonts=Object.fromEntries(Object.entries(s.availableFonts).map(([v,p])=>[v.trim().toLowerCase(),p])),this.debug=s.debug,this.queryFonts=s.queryFonts,this._getFont=a,this._defaultFont=s.defaultFont.trim().toLowerCase();const c=globalThis.fetch;globalThis.fetch=v=>c(s.wasmUrl);const h=({data:v})=>{v.name==="offscreenCanvas"&&(this._offCanvas=v.ctrl,this._gpurender.setCanvas(this._offCanvas),removeEventListener("message",h))};addEventListener("message",h);try{const v=new OffscreenCanvas(1,1);v.getContext("webgl2")?this._gpurender=new Ps:this._gpurender=v.getContext("webgl")?.getExtension("ANGLE_instanced_arrays")?new xs:new or}catch{this._gpurender=new or}this._ready=Ar({__url:s.wasmUrl,__out:v=>this._log(v)}).then(async({_malloc:v,JASSUB:p})=>{this._malloc=v,this._wasm=new p(s.width,s.height,this._defaultFont),this._wasm.setThreads(wr),this._loadInitialFonts(s.fonts),this._wasm.createTrackMem(s.subContent??await dr(s.subUrl)),this._subtitleColorSpace=fr[this._wasm.trackColorSpace],(s.libassMemoryLimit>0||s.libassGlyphLimit>0)&&this._wasm.setMemoryLimits(s.libassGlyphLimit||0,s.libassMemoryLimit||0),this._checkColorSpace()})}ready(){return this._ready}createEvent(s){De(s,this._wasm.getEvent(this._wasm.allocEvent()))}getEvents(){const s=[];for(let a=0;a<this._wasm.getEventCount();a++){const{Start:c,Duration:h,ReadOrder:v,Layer:p,Style:_,MarginL:A,MarginR:m,MarginV:g,Name:y,Text:x,Effect:E}=this._wasm.getEvent(a);s.push({Start:c,Duration:h,ReadOrder:v,Layer:p,Style:_,MarginL:A,MarginR:m,MarginV:g,Name:y,Text:x,Effect:E})}return s}setEvent(s,a){De(s,this._wasm.getEvent(a))}removeEvent(s){this._wasm.removeEvent(s)}createStyle(s){const a=this._wasm.getStyle(this._wasm.allocStyle());return De(s,a),a}getStyles(){const s=[];for(let a=0;a<this._wasm.getStyleCount();a++){const{Name:c,FontName:h,FontSize:v,PrimaryColour:p,SecondaryColour:_,OutlineColour:A,BackColour:m,Bold:g,Italic:y,Underline:x,StrikeOut:E,ScaleX:M,ScaleY:S,Spacing:X,Angle:j,BorderStyle:z,Outline:F,Shadow:se,Alignment:q,MarginL:N,MarginR:ae,MarginV:pe,Encoding:Z,treat_fontname_as_pattern:Ie,Blur:ye,Justify:me}=this._wasm.getStyle(a);s.push({Name:c,FontName:h,FontSize:v,PrimaryColour:p,SecondaryColour:_,OutlineColour:A,BackColour:m,Bold:g,Italic:y,Underline:x,StrikeOut:E,ScaleX:M,ScaleY:S,Spacing:X,Angle:j,BorderStyle:z,Outline:F,Shadow:se,Alignment:q,MarginL:N,MarginR:ae,MarginV:pe,Encoding:Z,treat_fontname_as_pattern:Ie,Blur:ye,Justify:me})}return s}setStyle(s,a){De(s,this._wasm.getStyle(a))}removeStyle(s){this._wasm.removeStyle(s)}styleOverride(s){this._wasm.styleOverride(this.createStyle(s))}disableStyleOverride(){this._wasm.disableStyleOverride()}setTrack(s){this._wasm.createTrackMem(s),this._subtitleColorSpace=fr[this._wasm.trackColorSpace]}freeTrack(){this._wasm.removeTrack()}async setTrackByUrl(s){this.setTrack(await dr(s))}_checkColorSpace(){!this._subtitleColorSpace||!this._videoColorSpace||this._gpurender.setColorMatrix(this._subtitleColorSpace,this._videoColorSpace)}_defaultFont;setDefaultFont(s){this._defaultFont=s.trim().toLowerCase(),this._wasm.setDefaultFont(this._defaultFont)}async _log(s){console.debug(s);const a=s.match(/JASSUB: fontselect:[^(]+: \(([^,]+), (\d{1,4}), \d\)/);a&&!await this._findAvailableFont(a[1].trim().toLowerCase(),lr[Math.ceil(parseInt(a[2])/100)-1])&&await this._findAvailableFont(this._defaultFont)}async addFonts(s){if(!s.length)return;const a=[],c=[];for(const h of s)typeof h=="string"?a.push(h):c.push(h);return c.length&&this._allocFonts(c),await Promise.allSettled(a.map(h=>this._asyncWrite(h)))}_loadedInitialFonts=!1;async _loadInitialFonts(s){await this.addFonts(s),this._loadedInitialFonts=!0}_getFont;_availableFonts={};_checkedFonts=new Set;async _findAvailableFont(s,a){if(!this._loadedInitialFonts)return;for(const h of lr)if(s.includes(h)){s=s.replace(h,"").trim(),a??=h;break}a??="regular";const c=s+" "+a;if(!this._checkedFonts.has(c)){this._checkedFonts.add(c);try{const h=this._availableFonts[c]??this._availableFonts[s]??await this._queryLocalFont(s,a)??await this._queryRemoteFont([c,s]);if(h)return await this.addFonts([h])}catch(h){console.warn("Error querying font",s,a,h)}}}queryFonts;async _queryLocalFont(s,a){if(this.queryFonts)return await this._getFont(s,a)}async _queryRemoteFont(s){if(this.queryFonts!=="localandremote")return;const a=await ms({postscriptNames:s});if(!a.length)return;const c=await a[0].blob();return new Uint8Array(await c.arrayBuffer())}async _asyncWrite(s){const a=await Tr(s);this._allocFonts([new Uint8Array(await a.arrayBuffer())])}_fontId=0;_allocFonts(s){for(const a of s){const c=this._malloc(a.byteLength);self.HEAPU8RAW.set(a,c),this._wasm.addFont("font-"+this._fontId++,c,a.byteLength)}this._wasm.reloadFonts()}_resizeCanvas(s,a,c,h){this._wasm.resizeCanvas(s,a,c,h),this._gpurender.resizeCanvas(s,a)}async[ve](){await this._ready,this._wasm.quitLibrary(),this._gpurender.destroy(),this._wasm=null,this._gpurender=null,this._availableFonts={}}_draw(s,a=!1){if(!this._offCanvas||!this._gpurender)return;const c=this._wasm.rawRender(s,Number(a));if(this._wasm.changed===0&&!a)return;const h=[];for(let v=c,p=0;p<this._wasm.count;v=v.next,++p)h.push({bitmap:v.bitmap,color:v.color,dst_x:v.dst_x,dst_y:v.dst_y,h:v.h,stride:v.stride,w:v.w});this._gpurender.render(h,self.HEAPU8RAW)}_setColorSpace(s){s!=="RGB"&&(this._videoColorSpace=s,this._checkColorSpace())}}self.name==="jassub-worker"&&vs(Fs);
